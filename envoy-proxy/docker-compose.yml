version: '3.8'

services:
  # Consul服务发现
  consul-server:
    image: consul:1.15
    container_name: consul-server
    ports:
      - "8500:8500"  # Web UI
      - "8600:8600/udp"  # DNS
    volumes:
      - ./consul/config.json:/consul/config/config.json:ro
      - consul-data:/consul/data
    command: 
      - "agent"
      - "-config-file=/consul/config/config.json"
      - "-client=0.0.0.0"
    networks:
      - game-network

  # Envoy代理
  envoy-proxy:
    image: envoyproxy/envoy:v1.28-latest
    container_name: envoy-proxy
    ports:
      - "10000:10000/udp"  # 游戏服务器1代理端口
      - "10001:10001/udp"  # 游戏服务器2代理端口
      - "10002:10002/udp"  # 游戏服务器3代理端口
      - "9901:9901"  # Envoy管理端口
    volumes:
      - ./envoy/envoy-precise-routing.yaml:/etc/envoy/envoy.yaml:ro
    depends_on:
      - consul-server
      - game-server-1
      - game-server-2
      - game-server-3
    networks:
      - game-network
    command: 
      - "-c"
      - "/etc/envoy/envoy.yaml"
      - "--service-cluster"
      - "game-proxy"
      - "--service-node"
      - "proxy-1"

  # 游戏服务器实例1
  game-server-1:
    build:
      context: ./game-server
      dockerfile: Dockerfile
    container_name: game-server-1
    ports:
      - "8080:8080/udp"
      - "9080:9080"
    environment:
      - SERVER_ID=game-server-1
      - SERVER_PORT=8080
    networks:
      - game-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8080"]
      interval: 10s
      timeout: 5s
      retries: 3

  # 游戏服务器实例2
  game-server-2:
    build:
      context: ./game-server
      dockerfile: Dockerfile
    container_name: game-server-2
    ports:
      - "8081:8081/udp"
      - "9081:9081"
    environment:
      - SERVER_ID=game-server-2
      - SERVER_PORT=8081
    networks:
      - game-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8081"]
      interval: 10s
      timeout: 5s
      retries: 3

  # 游戏服务器实例3
  game-server-3:
    build:
      context: ./game-server
      dockerfile: Dockerfile
    container_name: game-server-3
    ports:
      - "8082:8082/udp"
      - "9082:9082"



    environment:
      - SERVER_ID=game-server-3
      - SERVER_PORT=8082
    networks:
      - game-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8082"]
      interval: 10s
      timeout: 5s
      retries: 3

  # 服务注册器
  service-registrar:
    build:
      context: .
      dockerfile: Dockerfile.registrar
    container_name: service-registrar
    depends_on:
      - consul-server
      - game-server-1
      - game-server-2
      - game-server-3
    networks:
      - game-network
    environment:
      - CONSUL_URL=http://consul-server:8500

  # 测试客户端
  # test-client:
  #   build:
  #     context: ./test-client
  #     dockerfile: Dockerfile
  #   container_name: test-client
  #   depends_on:
  #     - envoy-proxy
  #   networks:
  #     - game-network
  #   stdin_open: true
  #   tty: true

volumes:
  consul-data:

networks:
  game-network:
    driver: bridge