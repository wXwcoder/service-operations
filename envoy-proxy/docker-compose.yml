services:
  # Consul服务发现（启用xDS服务网格）
  consul-server:
    image: consul:1.15
    container_name: consul-server
    ports:
      - "8500:8500"  # Web UI
      - "8502:8502"  # gRPC端口（xDS）
      - "8600:8600/udp"  # DNS
    volumes:
      - ./consul/config-enhanced.json:/consul/config/config.json:ro
      - consul-data:/consul/data
    command: 
      - "agent"
      - "-server"
      - "-bootstrap-expect=1"
      - "-ui"
      - "-config-file=/consul/config/config.json"
      - "-client=0.0.0.0"
    healthcheck:
      test: ["CMD", "consul", "catalog", "datacenters"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - game-network

  # xDS控制平面服务 - 动态生成Envoy配置
  control-plane:
    build:
      context: ./control-plane
      dockerfile: Dockerfile
    container_name: control-plane
    ports:
      - "18000:18000"  # xDS gRPC端口
      - "8080:8080"    # 健康检查端口
    environment:
      - CONSUL_ADDR=consul-server:8500
      - XDS_PORT=18000
      - ENVOY_NODE_ID=proxy-1   # 必须与 Envoy 的 --service-node 一致，否则 Envoy 拿不到动态配置
    volumes:
      - ./.cursor:/.cursor
    depends_on:
      - consul-server
    networks:
      - game-network
    restart: unless-stopped

  # Envoy代理 - 从控制平面获取动态配置
  envoy-proxy:
    image: envoyproxy/envoy:v1.28-latest
    container_name: envoy-proxy
    ports:
      - "10000-10100:10000-10100/udp"  # 动态UDP端口范围
      - "9901:9901"  # Envoy管理端口
    volumes:
      - ./envoy/envoy-dynamic-udp.yaml:/etc/envoy/envoy.yaml:ro
    depends_on:
      - consul-server
      - control-plane
    networks:
      - game-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "consul-server:127.0.0.1"  # 映射consul-server到本地主机
    command: 
      - "-c"
      - "/etc/envoy/envoy.yaml"
      - "--service-cluster"
      - "game-proxy"
      - "--service-node"
      - "proxy-1"
    restart: unless-stopped

  # 游戏服务器实例1 - 外部端口 10000
  game-server-1:
    build:
      context: ./game-server
      dockerfile: Dockerfile
    container_name: game-server-1
    ports:
      - "8080:8080/udp"
      - "9080:9080"
    environment:
      - SERVER_ID=game-server-1
      - SERVER_PORT=8080
      - EXTERNAL_PORT=10000  # 对应外部UDP端口
      - CONSUL_URL=http://consul-server:8500
    networks:
      - game-network
    depends_on:
      consul-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8080"]
      interval: 10s
      timeout: 5s
      retries: 3

  # 游戏服务器实例2 - 外部端口 10001
  game-server-2:
    build:
      context: ./game-server
      dockerfile: Dockerfile
    container_name: game-server-2
    ports:
      - "8081:8081/udp"
      - "9081:9081"
    environment:
      - SERVER_ID=game-server-2
      - SERVER_PORT=8081
      - EXTERNAL_PORT=10001  # 对应外部UDP端口
      - CONSUL_URL=http://consul-server:8500
    networks:
      - game-network
    depends_on:
      consul-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8081"]
      interval: 10s
      timeout: 5s
      retries: 3

  # 游戏服务器实例3 - 外部端口 10002
  game-server-3:
    build:
      context: ./game-server
      dockerfile: Dockerfile
    container_name: game-server-3
    ports:
      - "8082:8082/udp"
      - "9082:9082"
    environment:
      - SERVER_ID=game-server-3
      - SERVER_PORT=8082
      - EXTERNAL_PORT=10002  # 对应外部UDP端口
      - CONSUL_URL=http://consul-server:8500
    networks:
      - game-network
    depends_on:
      consul-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8082"]
      interval: 10s
      timeout: 5s
      retries: 3

  # 测试客户端
  # test-client:
  #   build:
  #     context: ./test-client
  #     dockerfile: Dockerfile
  #   container_name: test-client
  #   depends_on:
  #     - envoy-proxy
  #   networks:
  #     - game-network
  #   stdin_open: true
  #   tty: true

volumes:
  consul-data:

networks:
  game-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/16